import{u as N,j as e,n as P,o as C,ar as $,p as w,I as f,B as v,L as y,d as k}from"./ui-TF4rhkS0.js";import{r as p,u as S,d as A}from"./vendor-CYNtys_G.js";import{u as F,c as E}from"./index-lQGp847G.js";import{c as I,a as D}from"./client-DO6i2ohs.js";const L=o=>{const a=o.replace(/\D/g,"");return a.length<=3?a:a.length<=6?`${a.slice(0,3)}.${a.slice(3)}`:a.length<=9?`${a.slice(0,3)}.${a.slice(3,6)}.${a.slice(6)}`:`${a.slice(0,3)}.${a.slice(3,6)}.${a.slice(6,9)}-${a.slice(9,11)}`},V=o=>{const a=o.replace(/\D/g,"");return a.length<=2?a:a.length<=7?`(${a.slice(0,2)}) ${a.slice(2)}`:`(${a.slice(0,2)}) ${a.slice(2,7)}-${a.slice(7,11)}`},q=({planId:o,onPaymentSuccess:a,onCancel:d})=>{var j;const{user:l}=F(),{toast:g}=N(),[s,i]=p.useState({name:((j=l==null?void 0:l.user_metadata)==null?void 0:j.name)||"",email:(l==null?void 0:l.email)||"",cpf:"",phone:""}),[u,x]=p.useState(!1),[m,t]=p.useState(null),h=b=>{m&&t(null);const{name:c,value:r}=b.target;i(c==="cpf"?n=>({...n,[c]:L(r)}):c==="phone"?n=>({...n,[c]:V(r)}):n=>({...n,[c]:r}))},X=async b=>{if(b.preventDefault(),t(null),!l){t("Você precisa estar logado para assinar um plano.");return}if(!s.name||!s.email||!s.cpf){t("Por favor, preencha todos os campos obrigatórios.");return}const c=s.cpf.replace(/\D/g,"");if(c.length!==11){t("Por favor, insira um CPF válido com 11 dígitos.");return}x(!0);try{console.log("Iniciando criação de cliente no Asaas...");const r=await I({name:s.name,email:s.email,cpfCnpj:c,mobilePhone:s.phone.replace(/\D/g,"")});console.log("Cliente criado/recuperado com ID:",r),console.log("Criando assinatura para o cliente...");const{redirectUrl:n}=await D(o,l.id,r);console.log("Assinatura criada, redirecionando para:",n),o==="free"||n.includes("free=true")?(g({title:"Plano ativado com sucesso!",description:"Seu plano gratuito foi ativado com sucesso."}),a()):(g({title:"Redirecionando para pagamento",description:"Uma nova janela foi aberta para concluir o pagamento via PIX."}),window.open(n,"_blank"),t(`Se a janela de pagamento não abrir, clique neste link: <a href="${n}" target="_blank" class="text-blue-400 underline">Abrir página de pagamento</a>`))}catch(r){console.error("Erro no processo de assinatura:",r);let n="Ocorreu um erro ao processar sua assinatura.";r instanceof Error?(t(`${n} ${r.message}`),r.message.includes("405")?t("Erro na comunicação com a API de pagamento. Por favor, entre em contato com o suporte."):r.message.includes("Network Error")&&t("Erro de conexão. Verifique sua internet e tente novamente.")):t(n)}finally{x(!1)}};return e.jsxs("div",{className:"w-full p-6 mx-auto rounded-lg",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Complete seus dados de pagamento"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"O pagamento será processado via PIX através da plataforma Asaas"}),m&&e.jsxs(P,{variant:"destructive",className:"mb-4",children:[e.jsx(C,{className:"h-4 w-4"}),e.jsx($,{children:"Erro"}),e.jsx(w,{dangerouslySetInnerHTML:{__html:m}})]}),e.jsxs("form",{onSubmit:X,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-300 mb-1",children:"Nome completo *"}),e.jsx(f,{id:"name",name:"name",value:s.name,onChange:h,placeholder:"Seu nome completo",className:"w-full bg-vegas-black border-gray-700",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-300 mb-1",children:"E-mail *"}),e.jsx(f,{id:"email",name:"email",type:"email",value:s.email,onChange:h,placeholder:"seu@email.com",className:"w-full bg-vegas-black border-gray-700",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"cpf",className:"block text-sm font-medium text-gray-300 mb-1",children:"CPF *"}),e.jsx(f,{id:"cpf",name:"cpf",value:s.cpf,onChange:h,placeholder:"XXX.XXX.XXX-XX",maxLength:14,className:"w-full bg-vegas-black border-gray-700",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"phone",className:"block text-sm font-medium text-gray-300 mb-1",children:"Telefone"}),e.jsx(f,{id:"phone",name:"phone",value:s.phone,onChange:h,placeholder:"(XX) XXXXX-XXXX",maxLength:15,className:"w-full bg-vegas-black border-gray-700"})]}),e.jsxs("div",{className:"pt-2 flex space-x-3",children:[e.jsx(v,{type:"button",variant:"outline",onClick:d,className:"flex-1",disabled:u,children:"Cancelar"}),e.jsx(v,{type:"submit",className:"flex-1 bg-vegas-gold hover:bg-vegas-gold/80 text-black",disabled:u,children:u?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-4 w-4 animate-spin"}),"Processando..."]}):"Continuar para pagamento"})]})]})]})},B=()=>{const{planId:o}=S(),{availablePlans:a,loading:d}=E(),[l,g]=p.useState(null),s=A(),{toast:i}=N();p.useEffect(()=>{if(!d&&a&&o){const m=a.find(t=>t.id===o);m?g(m):(i({title:"Plano não encontrado",description:"O plano selecionado não está disponível.",variant:"destructive"}),s("/planos"))}},[d,a,o,s,i]);const u=()=>{s("/payment-success")},x=()=>{s("/planos")};return d||!l?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx(y,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"container mx-auto py-12 px-4 max-w-4xl",children:[e.jsxs(v,{variant:"ghost",className:"mb-6",onClick:()=>s("/planos"),children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Voltar para planos"]}),e.jsxs("div",{className:"bg-vegas-black/40 border border-gray-700 rounded-lg p-6 mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-2",children:"Finalizar assinatura"}),e.jsxs("p",{className:"text-gray-400 mb-4",children:["Você selecionou o plano ",e.jsx("span",{className:"font-semibold text-vegas-gold",children:l.name})]}),e.jsxs("div",{className:"flex items-center justify-between border-t border-gray-700 pt-4 mt-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-400",children:"Valor"}),e.jsx("p",{className:"text-xl font-bold",children:l.price===0?"Grátis":`R$ ${l.price.toFixed(2)}/${l.interval==="monthly"?"mês":"ano"}`})]}),l.interval==="annual"&&e.jsx("div",{className:"bg-vegas-gold/20 text-vegas-gold text-sm px-3 py-1 rounded-full",children:"2 meses grátis"})]})]}),e.jsx(q,{planId:o||"",onPaymentSuccess:u,onCancel:x})]})};export{B as default};
